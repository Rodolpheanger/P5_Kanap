const getItemId=()=>new URL(window.location.href).searchParams.get("id"),fetchItemData=async()=>{try{const itemId=getItemId(),response=await fetch("http://localhost:3000/api/products/"+itemId);return response.json()}catch(error){console.log(error),alert("Nous rencontrons actuellement des difficultés pour accéder à cet article.\nMerci de réessayer ultèrieurement.\nVeuillez nous excuser pour la gêne occasionnée.")}},productPageInit=async()=>{const item=await fetchItemData();pageTitleDisplay(item.name),itemImageDisplay(item.imageUrl,item.altTxt),itemNameDisplay(item.name),itemPriceDisplay(item.price),itemDescriptionDisplay(item.description),itemColorsDisplay(item.colors),addToCartInit()},pageTitleDisplay=itemName=>{document.title=itemName},itemImageDisplay=(itemUrl,itemAltTxt)=>{let image=document.createElement("img");image.setAttribute("src",itemUrl),image.setAttribute("alt",itemAltTxt),document.querySelector(".item__img").appendChild(image)},itemNameDisplay=itemName=>{document.getElementById("title").textContent=itemName},itemPriceDisplay=itemPrice=>{document.getElementById("price").textContent=itemPrice},itemDescriptionDisplay=itemDescription=>{document.getElementById("description").textContent=itemDescription},itemColorsDisplay=itemColors=>{for(const color of itemColors){let colorOption=new Option(color,color);document.getElementById("colors").appendChild(colorOption)}},addToCartInit=()=>{document.getElementById("addToCart").addEventListener("click",()=>{const itemNameContainer=document.getElementById("title"),itemColorsContainer=document.getElementById("colors"),itemQuantityContainer=document.getElementById("quantity"),itemQuantityContainerValue=Number.parseInt(itemQuantityContainer.value);checkValidity(itemColorsContainer.value,itemNameContainer.textContent,itemQuantityContainerValue)})},checkValidity=(itemColor,itemName,itemQuantity)=>{const itemId=getItemId(),localStorageData=getLocalStorage(itemId,itemColor),totalItemQuantityIsOverTheMax=checkTotalCartQuantity(localStorageData,itemId,itemColor,itemQuantity,itemName);totalItemQuantityIsOverTheMax||(""==itemColor?alert(`Veuillez séléctionner une couleur pour votre ${itemName}`):itemQuantity<=0|isNaN(itemQuantity)?alert(`Veuillez indiquer le nombre de ${itemName} que vous souhaitez ajouter au panier (minimum 1 et maximum 100)`):itemQuantity>100?alert(`Vous dépassez le nombre maximum de ${itemName} que vous pouvez ajouter au panier (maximum autorisé 100)`):(addToCart(localStorageData,itemId,itemColor,itemQuantity),validationMessage(itemQuantity,itemName,itemColor)))},getLocalStorage=()=>{let localStorageData=JSON.parse(window.localStorage.getItem("cart"));return null==localStorageData?[]:localStorageData},checkTotalCartQuantity=(localStorageData,itemId,itemColor,itemQuantity,itemName)=>{for(const entry of localStorageData)if(entry.id===itemId&&entry.color===itemColor&&entry.quantity+itemQuantity>100){const maxToAdd=100-entry.quantity;return alert(`Vous dépassez le nombre maximum de ${itemName} ${itemColor} que vous pouvez avoir dans votre panier (ajout maximum possible ${maxToAdd})`),!0}},addToCart=(localStorageData,itemId,itemColor,itemQuantity)=>{const newProduct={id:itemId,color:itemColor,quantity:itemQuantity};createOrModifyEntry(localStorageData,itemId,newProduct)},createOrModifyEntry=(localStorageData,itemId,newProduct)=>{for(const entry of localStorageData)if(entry.id===itemId&&entry.color===newProduct.color&&entry.quantity+newProduct.quantity<=100)return entry.quantity+=newProduct.quantity,setLocalStorage(localStorageData);newEntryPush(localStorageData,newProduct)},newEntryPush=(localStorageData,productToPush)=>{localStorageData.push({id:productToPush.id,color:productToPush.color,quantity:productToPush.quantity}),setLocalStorage(localStorageData)},setLocalStorage=cartData=>{cartData.sort((a,b)=>a.id<b.id?-1:a.id>b.id?1:0);const cartDataToStringnify=JSON.stringify(cartData);window.localStorage.setItem("cart",cartDataToStringnify)},validationMessage=(itemQuantity,itemName,itemColor)=>{confirm(`Vous venez d'ajouter ${itemQuantity} ${itemName} ${itemColor} à votre panier. \nCliquez sur OK pour y accéder  \nou sur ANNULER pour continuer vos achats.`)?location.href="../html/cart.html":location.href="../html/index.html"};productPageInit();